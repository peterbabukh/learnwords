define(["backbone","app/WordModelView","app/NewEntryFormView","i18n!../../js/nls/ru","helpers/getComputedStyle","app/UserModel","text!../../templates/wordsCollectionViewHeader.html","text!../../templates/liTemplate.html","text!../../templates/tableTemplate.html","app/WordsCollection","app/AppHeaderView"],function(a,b,c,d,e,f,g,h,i,j,k){"use strict";var l=a.View.extend({el:$(".content-box"),initialize:function(){this.user=new f,this.childViews=[]},events:{"click .groups-li":"selectGroup","click .td-filter":"filterTable","click .reset-filed":"resetFiledItems","click .reset-all":"resetAllItems"},render:function(){var a=this;return this.childViews.length&&this.onClose(),this.user.fetch({success:function(b,c,d){a.collection=new j(b.get("words").models),a.collection.on("add",a.handleSuccess,a)},error:function(b,c,d){a.handleError()}}).done(function(){a.handleSuccess()}),this},handleSuccess:function(){var a=_.template(g,d);this.$el.html(a),this.showNewEntryForm(),this.createGroupList(),this.createTable(),this.setOpacity(this.opacityIndex),this.appendHeader()},handleError:function(){alert(d.msg.systemErrorMessage),console.log(d.msg.systemErrorMessage),this.goTo("/list"),window.location.reload()},showNewEntryForm:function(){var a=new c;a.collection=this.collection,this.$el.append(a.render().el),this.childViews.push(a)},createGroupList:function(){var a=_.template(h),b=_.uniq(_.pluck(_.sortBy(this.collection.toJSON(),"wordGroup"),"wordGroup"));_.each(b,function(b){$(".groups-ul").append(a({li:b.trim()}))})},createTable:function(){var a=_.template(i);this.$el.append(a(d)),this.collection.each(function(a){a.set("i18n",d);var c=new b({model:a});this.childViews.push(c),$(".collection-table").append(c.render().el)},this),this.setHeadWidth()},setHeadWidth:function(){var a=document.querySelectorAll(".collection-table tr:first-child td"),b=document.querySelectorAll(".td-filter");_.each(b,function(b,c){var d=2*parseInt(e.getStyle(b).paddingRight),f=parseInt(e.getStyle(b).borderRight);b.width=a[c].offsetWidth-d-f+"px"})},selectGroup:function(a){a=a||window.event;var b=a.target||a.srcElement;$(".new-entry-input").val($(b).text())},filterTable:function(a){a=a||window.event;var b,c;switch(b=a.target||a.srcElement,b=$(b).closest("td"),c=$(b)[0].cellIndex){case 0:this.collection.comparator=function(a){return a.get("enWord")},this.collection.sort();break;case 1:this.collection.comparator=function(a){return a.get("ruWord")},this.collection.sort();break;case 2:this.collection.comparator=function(a){return a.get("wordGroup")},this.collection.sort();break;default:this.collection.comparator=function(a){return a.get("enWord")}}this.opacityIndex=c,$(".fixed-head, .collection-table-container").remove(),this.createTable(),this.setOpacity(this.opacityIndex)},opacityIndex:0,setOpacity:function(a){var b=this.$el.find(".filter-arrow");_.each(b,function(a){$(a).css({opacity:1})&&$(a).css({opacity:.2})}),$(b[a]).css({opacity:1})},resetFiledItems:function(){var a=this,b=confirm(d.conf.baseReloadFirstWarning.join(" "));if(b){var c=confirm(d.conf.baseReloadSecondWarning.join(" "));c&&$.when(a.goTo("/resetFiled")).then(function(){window.location.reload()})}},resetAllItems:function(){var a=this,b=confirm(d.conf.fullReloadFirstWarning.join(" "));if(b){var c=confirm(d.conf.fullReloadSecondWarning.join(" "));c&&$.when(a.goTo("/resetAll")).then(function(){window.location.reload()})}},appendHeader:function(){var a=new k;this.$el.prepend(a.render().el),this.childViews.push(a)},onClose:function(){var a=this.childViews;_.each(a,function(a){a.close()})}});return l});